{% include 'header.html' %}
<div class="w-11/12 max-w-md bg-white p-6 rounded-lg shadow-md">
  <h1 class="text-center text-lg font-bold mb-6">Kapalinga</h1>

  <!-- Language Selection -->
  <div class="flex items-center justify-between mb-6">
    <!-- Dropdown for Language 1-->
    <div class="relative">
      <select id="language1" class="block w-full bg-gray-100 border border-gray-300 rounded-lg py-2 px-4 focus:outline-none focus:ring focus:border-gray-400">
        <option>English</option>
        <option>Tagalog</option>
        <option>Kapampangan</option>
      </select>
    </div>

    <!-- Swap Button -->
    <button id="swapBtn" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 transition">
      <span class="text-xl">â‡†</span>
    </button>

    <!-- Dropdown for Language 2-->
    <div class="relative">
      <select id="language2" class="block w-full bg-gray-100 border border-gray-300 rounded-lg py-2 px-4 focus:outline-none focus:ring focus:border-gray-400">
        <option>Kapampangan</option>
        <option>English</option>
        <option>Tagalog</option>
      </select>
    </div>
  </div>

  <!-- Input and Output Text Areas -->
  <div class="space-y-4">
    <!-- Input Area -->
    <textarea
      id="inputText"
      class="w-full h-24 bg-white-100 border border-gray-300 rounded-lg p-4 focus:outline-none focus:ring focus:border-gray-400 resize-none"
      placeholder="Enter text here"
    ></textarea>

    <!-- Output Area -->
    <div class="w-full h-24 bg-gray-100 border border-gray-300 rounded-lg p-4">
      <p id="translatedText" class="text-gray-700">Translated text will appear here...</p>
    </div>
  </div>

  <!-- Microphone Toggle -->
  <div class="flex items-center justify-center mt-4">
    <button id="micToggle" class="bg-gray-200 p-2 rounded-full">
      <i id="micIcon" class="fa fa-microphone-slash text-xl"></i>
    </button>
  </div>
</div>

{% include 'footer.html' %}

<script src="/static/js/mic_controller.js"></script>
<script>

// Check for microphone permission and request it
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // Modern browsers with getUserMedia() under navigator.mediaDevices
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then((stream) => {
        // Permission granted, start speech recognition
        console.log('Microphone permission granted');
        
        // Initialize SpeechRecognition
        const micToggle = document.getElementById('micToggle');
        const micIcon = document.getElementById('micIcon');
        const inputText = document.getElementById('inputText');
  
        let recognition;
  
        // Check if the browser supports SpeechRecognition
        if ('webkitSpeechRecognition' in window) {
          recognition = new webkitSpeechRecognition();
          recognition.continuous = true; // Keep listening until stopped
          recognition.interimResults = true; // Show interim results
          recognition.lang = 'en-US'; // Set language (can be adjusted based on language selection)
        } else {
          alert('Speech Recognition not supported in this browser.');
          return;
        }
  
        // Toggle microphone icon and start/stop recognition
        micToggle.addEventListener('click', () => {
          if (micIcon.classList.contains('fa-microphone-slash')) {
            micIcon.classList.remove('fa-microphone-slash');
            micIcon.classList.add('fa-microphone');
            recognition.start(); // Start speech recognition
          } else {
            micIcon.classList.remove('fa-microphone');
            micIcon.classList.add('fa-microphone-slash');
            recognition.stop(); // Stop speech recognition
          }
        });
  
        // Update the textarea with recognized speech
        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          inputText.value = transcript; // Set the inputText area with the recognized speech
        };
  
        // Handle recognition errors
        recognition.onerror = (event) => {
          console.error('Speech Recognition Error: ', event.error);
        };
  
      })
      .catch((err) => {
        // Permission denied or other error
        console.error('Error accessing the microphone: ', err);
        alert('Permission to access the microphone is required for speech recognition.');
      });
  } else if (navigator.getUserMedia) {
    // Support for older versions of browsers
    navigator.getUserMedia({ audio: true }, (stream) => {
      console.log('Microphone permission granted');
      // Initialize SpeechRecognition and other code...
    }, (err) => {
      console.error('Error accessing the microphone: ', err);
      alert('Permission to access the microphone is required for speech recognition.');
    });
  } else {
    alert('Your browser does not support microphone access.');
  }

 $('#inputText').on('input', function() {
  const inputText = $('#inputText').val();
  const language1 = $('#language1').val().toLowerCase();
  const language2 = $('#language2').val().toLowerCase();

  // API endpoint
  const endpoint = '/translate';

  // Check if input text is not empty
  if (inputText.trim() !== '') {
    // Show loading text
    $('#translatedText').text('Translating...');

    // Use a POST request to send the input text and language information
    fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        text: inputText,
        from_lang: language1,
        to_lang: language2
      }),
    })
    .then(response => response.json())
    .then(data => {
      const translatedText = data.translation || 'No translation available';
      $('#translatedText').text(translatedText);
    })
    .catch(error => {
      console.error('Error:', error);
      $('#translatedText').text('Error occurred while translating.');
    });
  } else {
    // If input is empty, clear the output area
    $('#translatedText').text('Translated text will appear here...');
  }
});

  // Swap the two languages
  $('#swapBtn').click(function() {
    const lang1 = $('#language1').val();
    const lang2 = $('#language2').val();

    // Swap the values
    $('#language1').val(lang2);
    $('#language2').val(lang1);

    // Ensure that one of the dropdowns is always set to Kapampangan
    if ($('#language1').val() !== 'Kapampangan' && $('#language2').val() !== 'Kapampangan') {
      $('#language1').val('Kapampangan');
    }
  });


</script>
